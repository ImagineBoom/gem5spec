
---

English | [简体中文](./README-ZH.md)

---


## Project Configuration

All configuration items are specified in the `runspec_gem5_power/params.mk` file

✅ Make sure that SPEC2017 has been successfully [compiled](https://github.com/griffin-warrior/gem5spec)
- Configure `SPEC_HOME` and make sure the path where `SPEC_HOME` is located matches a similar rule to `$(SPEC_HOME)/benchspec/CPU/541.leela_r`
- Set `LABEL` according to the compilation platform, the value of `LABEL` will be set to the suffix of the executable when compiling SPEC2017. 

✅ Make sure that gem5 has been built successfully, and confirm the options and parameters below
- `GEM5_REPO_PATH`: Configure as the root path for gem5 repository
- `GEM5`: Confiture the path where the compiled results of gem5 are located, such as `gem5.opt`
- `BUILD_GEM5_J`: If gem5 is compiled from the script, you need to specify the number of parallel compilations
- `GEM5_OPT`: Direct parameters of `gem5.opt[fast..]`
- `GEM5_PY`: Path to `se.py`
- `GEM5_PY_OPT`: Options and parameters for `se.py`

✅ Make sure Simpoint`version: 3.2` has been successfully installed
- `SIMPOINT_EXE`: Path to the simpoint executable
- INTERVAL_SIZE
- WARMUP_LENGTH
- `NUM_CKP`: The checkpoint number specified when using make restore to run only one checkpoint

- [ ] Optional: Valgrind, count the number of instructions
- `VALGRIND_EXE`: Path to valgrind executable

## Simpoint

### 1. Generate BBV files and classify them using simpoint

The size of 'maxK' defaults to the value of the arithmetic square root of the number of intervals.

Run the following command in the directory of a single SPEC2017 test case

```shell
make simpoint
```

This command will use the `NonCachingSimpleCPU` model of gem5 to generate representative points for the program and generate a Basic Block Vector(BBV) file. Then use simpoint to classify the file and generate `.simpts` and `.weights` files. For the convenience of parsing, this script will then merge and sort these two files(in ascending order of starting instruction position), and save the results to the `.merge` file

If you want to generate `.merge` files for 24 test cases at once, run the following command in the  `runspec_gem5_power` directory.

```bash
make simpoints_all_cases -j24
```

> - For some programs that don't know the number of instructions, you can modify the following command to obtain the program's number of instruction by using valgrind to determine the size of the `interval`
>
>   ```sh
>   $VALGRIND_EXE --tool=exp-bbv --instr-count-only=yes --bb-out-file=/dev/null $EXECUTABLE $ARGS
>   ```
>
> - If you want to see how many representative points each test case has, you can execute the following command in the "runspec_gem5_power" directory, and the results will be saved in Checkpoint_Num.csv file.
>
>   ```sh
>   make collect_checkpoints_number
>   ```

- *_gem5_bbv.log：Log file that records the process of gem5 generating BBV
- *_simpoint.log：Log file recording the execution process of simpoint
- *_trace.log：Log file recording the start and end time of the target

## Checkpoint

### 2. Read simpoint results to generate Checkpoints using gem5

After getting the simpoint results, you can use gem5 to generate the corresponding checkpoints by run the following command in the same case directory

```shell
make checkpoints
```

This command will make gem5 read the `.simpts` and `.weights` files,  and generate the corresponding checkpoints in the `m5out/` directory after complete execution of program using gem5's AtomicSimpleCPU

If you want to generate checkpoints for 24 test cases at once, run the following command in the runspec_gem5_power` directory
```shell
make checkpoints_all_cases -j24
```

If you use gem5's replicated multi-core mode to generate checkpoints file of 24 test cases, run the following command in the `runspec_gem5_power` directory

```bash
make checkpoints_all_cases_X -j24
```

Where `X` can be specified as 2,4,8, representing dual-core, qurd-core, octa-core respectively.

- *_checkpoints.log: Logging of checkpoints generated by gem5

## Restore

### 3. Restore checkpoint using gem5

#### 3.1 Restore only one checkpoint

After getting checkpoints, you can use gem5 to restore a checkpoint by using the following command in the directory of the test case
```bash
make restore NUM_CKP=1
```

The parameter `NUM_CKP` is used to specify the serial number of the `restore` checkpoint, note that the value of this parameter starts from 1, while the checkpoint in the `m5out` directory starts from 0, so you need to add offset 1 when specifying this parameter

Default CPU type `P8CPU`. *Note that `AtomicSimpleCPU` cannot be used here to recover checkpoints*

The output file of gem5 will be redirected to the `output_ckp'n'` directory in the current directory, where `n` has the same value as `NUM_CKP`

- *_restore_ckp'n'.log: Record the log of the nth checkpoint of gem5 restore

#### 3.2 Restore all checkpoints of a test case

Enter the following command in the `gem5spec` directory to `restore` all checkpoints of a test case
```bash
source auto_cmpl.sh 
./run.sh --gem5 --spec2017 --restore_case XXX -j N
```

> - `XXX` represents the test case number that needs to be restored, e.g. 500
>
> - Here `N` specifies the maximum number of parallelism, which can be determined according to the machine hardware situation and the current amount of tasks
>
> - The 'source auto_cmpl.sh' command is used to autocomplete prompts, and auto-completion can be used to speed up command input wherever 'run.sh' is used later
>
> - If you use the run.sh method to restore the operation, the data will be backed up in the directory '${GEM5_REPO_PATH}/data/gem5/${restore_begin_time}'

You can use `make restore_status` to see if all checkpoints have been executed for the current test case

- *_RS_NUM.log: Save the number of checkpoints that have been run, and append the corresponding Num to this file for each completed checkpoint, and compare the number of lines in this file with the .merge file to determine if all of them have been executed. (Note: the following X=2,4,8 method is not supported)
- `runspec_gem5_power`/git_diff.log: Save the git diff information each time you perform a restore operation with run.sh
- *_CKPS_CPI.log: Total 4 columns, checkpoint num, simpts, weights, cpi.(Note: the following X=2,4,8 is not supported)

> The number of simultaneous parallelisms can be dynamically adjusted when using run.sh
>
> - Increase the number of parallelism
>
>   ```sh
>   ./run.sh --control --add_job_10
>   ```
>
> - Reduce the number of parallelism. (⚠️ competitive reduction, currently there is no priority division, only when the checkpoint ends, the competition for execution rights will be carried out, and the execution rights will be released immediately after successful competition, and will do nothing, so as to achieve the purpose of reducing the number of parallelism. It doesn't kill jobs that are already executed or waiting to be executed)
>
>   ```sh
>   ./run.sh --control --reduce_job_10
>   ```
>
> - kill all "restore ckp"-related processes (jobs that are executing or waiting to be executed)
>
>   ```sh
>   ./run.sh --control --kill_restore_all_jobs --gem5
>   ```

#### 3.3 Restore all checkpoints for all test cases

Enter the following command in the `gem5spec` directory to `restore` the checkpoints for all test cases

```bash
./run.sh --gem5 --spec2017 --restore_all -j N
```

> The `N` here specifies the maximum number of parallelism, which can be determined by the machine hardware and the number of current tasks

If you want to restore checkpoints with a replicated multicore mode you can use the following command (checkpoints also need to be generated in the corresponding multicore mode)
```bash
./run.sh --gem5 --spec2017 --restore_all_X -j N
```
where X can be specified as 2, 4, 8, representing dual-core, quad-core and octa-core respectively

- If you need to compile gem5 automatically before running, you can use `--build_gem5_j` N

- If you need to modify gem5 parameters from the command line, you can use `--gem5_py_opt "--cpu-clock=8GHz"` (Note: X=2,4,8 is not supported)

- If you need to add some distinguishing marks to the backup directory in the data directory, you can use, for example, `--label "test"`, this way will modify the backup directory to `${GEM5_REPO_PATH}/data/gem5/${restore_begin_time}-${label}` (Note: not support X=2,4,8)
#### 3.4 Configure multiple continuous executions

Use `. /runArray.sh`, configure it and then run

#### 3.5 Support slurm mode execution

Use `. /runSlurm`, configure and then run

> #SBATCH --job-name=JOBNAME      %Specify the job name 
> #SBATCH --partition=debug       %Specify partition     
> #SBATCH --nodes=2               %Specify the number of nodes   
> #SBATCH --cpus-per-task=1       %Specify the number of cores used per process, default is 1 if not specified      
> #SBATCH -n 32                   %Specifies the total number of processes; without cpus-per-task, it is understood that the number of processes is the number of cores   
> #SBATCH --ntasks-per-node=16    %Specify the number of processes/nodes per node, use the -n parameter (higher priority) to change to the maximum number of tasks per node   
> #SBATCH --nodelist=node[3,4]    %Specify the priority node to be used   
> #SBATCH --exclude=node[1,5-6]   %Specify the nodes to avoid   

## Statistics

### 4. CPI Statistics

Since the `xxx_CKPS_CPI.log` generated in step 3.2 contains only the CPI of each checkpoint, which is not multiplied with the weights, the calculation can be performed using the following command
```bash
make cpi
```

This command will multiply the weight of each checkpoint in `xxx_CKPS_CPI.log` with CPI and insert the result into the fourth column and save it to `xxx_CKPS_Weighted_CPI.log`.

In addition, this command also sums up the CPI of each test case with weights, and generates a new csv file to save the above results, named `xxx_final_result_N.csv` (xxx is the name of the current test case; N is the sum of the weighted CPI)

If you need to have all test cases generate `xxx_final_result_N.csv` data records at once, you can use the following command in the `runspec_gem5_power` directory
```bash
make cpi_all_cases
```

To facilitate the selection of representative points based on CPI data at a later stage, you can use the following command in the `runspec_gem5_power` directory
```bash
make collect_all_cases_CPI -j24
```

This command iterates through the combined weighted CPI data of each case and saves the statistics to `All_case_weightedCPI.csv`.

Using the following command will iterate through the `xxx_final_result_N.csv` file for each test case and consolidate the data into the file `Each_case_ckp_data.csv`
```bash
make collect_checkpoints_number
```

So `Each_case_ckp_data.csv` will record the CPI data information of all checkpoints of all test cases
### 5. IPC Statistics

#### 5.1 Single-core mode

Since IPC statistics cannot be calculated directly with the weight of checkpoint, it is necessary to generate CPI data with weights in the `runspec_gem5_power` directory first.
```bash
make cpi_all_cases -j24
```

Then use the following command to get the IPC data for each case, and the statistics will be saved to the `All_case_IPC_st.csv` file
```bash
make collect_all_cases_IPC
```

#### 5.2 Multi-core mode

The same process as single-core mode, you need to first aggregate the CPI data with weights in multi-core mode, you can use the following command (where X can be specified as 2, 4, 8, representing dual-core, quad-core, octa-core, respectively)
```bash
make cpi_all_cases_X -j24
```

Then use the following command to count the IPC data in multi-core mode, the statistics will be saved to the `All_case_IPC_smtX.csv` file
```bash
make collect_all_cases_IPC_X
```

> At present, IPC statistics only support the data summary of all test cases, and do not support the IPC statistics of individual test cases.

### 6. L2 Cache MissRate & MPKI Statistics

To count the Miss#, Weighted Miss#, Access#, Weighted Access# of L2 Cache in each test case, you can use the following command
```bash
make mpki_l2_all_cases -j 24
```

Then use the following command to count the L2 Cache Miss Rate and MPKI for each case, the statistics will be saved to the `All_case_L2_MPKI_st.csv` file
```bash
make collect_all_cases_MPKI_L2
```

If you need to count the IPC data in multi-core mode use the following command (where X can be specified as 2, 4, 8, representing dual-core, quad-core and octa-core respectively), the statistics will be saved to the `All_case_L2_MPKI_smtX.csv` file
```bash
make collect_all_cases_MPKI_L2_X
```

### 7.Output file/directory description

Each of the different functions mentioned above generates a corresponding output file/directory in order to view and record the output results of each step.

1. xxx_gem5_bbv.log: Output information of the basic block vector (BBV) process using gem5
2. xxx_simpoints.log: The output of the BBV classification process using Simpoint
3. xxx_checkpoints.log: Output of the checkpoints process using gem5
4. xxx_restore.log: Output of the checkpoint process restored using gem5
5. xxx_trace.log: Logs the executed commands and the output of some of them
6. xxx_trace_error.log: Logs the commands that resulted in errors
7. xxx_bbv: Save the BBV file generated by gem5 and the simulation data of the generation process (stats.txt)
8. m5out: Save the generated checkpoints and the simulation data of the checkpoints generation process (stats.txt)
9. out_ckpN: Save the simulation data (stats.txt) of the process of recovering a checkpoint and the configuration information (config) of the simulator, N means the Nth checkpoint
10. xxx_CKPS_CPI_Err.log: Record the abnormal ckp information found during the execution of make cpi, cpi_2, cpi_4, cpi_8
11. xxx_CKPS_L2_MISS_ACCESS_Err.log: Record the abnormal ckp information found when make mkpi is executed